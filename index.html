<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Scout Card Generator Final</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: Arial, sans-serif; }
        body { background-color: #f0f2f5; padding: 20px; }
        .main-container { display: flex; gap: 40px; flex-wrap: wrap; justify-content: center; }
        .form-section { flex: 1; min-width: 300px; max-width: 450px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); height: fit-content; }
        .form-section h1 { color: #1e3a5f; text-align: center; margin-bottom: 10px; }
        .instruction { background-color: #e3f2fd; border: 1px solid #90caf9; color: #0d47a1; padding: 10px; border-radius: 5px; text-align: center; margin-bottom: 20px; font-size: 0.9em; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display:block; font-weight:bold; margin-bottom:4px; color:#333; font-size:0.9rem; }
        .form-group input, .form-group select { width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; }

        .control-panel { background:#f8f9fa; border:1px solid #ddd; padding:10px; border-radius:5px; margin-bottom:15px; }
        .control-panel h4 { margin-bottom:8px; color:#444; font-size:0.9rem; text-transform:uppercase; border-bottom:1px solid #ccc; padding-bottom:4px; }
        .slider-group { display:flex; align-items:center; justify-content:space-between; margin-bottom:5px; font-size:0.8rem; }
        .slider-group label { margin:0; width:60px; }
        .slider-group input { width:70%; }

        .buttons { margin-top:20px; display:flex; flex-direction:column; gap:10px; }
        .btn-download { background-color:#27ae60; color:white; padding:12px; border:none; border-radius:5px; cursor:pointer; font-weight:bold; font-size:16px; transition:0.2s; }
        .btn-download:hover { background-color:#219150; transform:translateY(-2px); }

        /* PREVIEW AREA - scaled for visual fit only */
        .preview-area { transform-origin: top left; transform: scale(0.65); }
        @media (min-width:1600px){ .preview-area{ transform:scale(0.8); } }
        @media (max-width:1200px){ .preview-area{ transform:scale(0.5); } }
        @media (max-width:768px){ .main-container{ flex-direction:column; } .preview-area{ transform:scale(0.35); margin:0 auto; } }
        .mt-30 { margin-top:30px; }

        /* CARD DESIGN: exact export size is 1011 x 638 (px) */
        .card-wrapper { width: 1011px; height: 638px; position: relative; overflow: hidden; background-color: white; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .bg-pattern, .bg-pattern-back { position:absolute; top:0; left:0; right:0; bottom:0; background: linear-gradient(to bottom, #1e3a5f 0%, #1e3a5f 13%, #5b87c4 13%, #5b87c4 87%, #1e3a5f 87%, #1e3a5f 100%); z-index:1; }
        .watermark { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:400px; opacity:0.15; z-index:2; pointer-events:none; }
        .watermark img { width:90%; display:block; }
        .card-content { position:relative; z-index:10; width:100%; height:100%; padding:20px; }

        /* HEADER */
        .top-header { position:absolute; top:85px; left:40px; display:flex; align-items:center; }
        .header-logo { width:130px; height:130px; background:transparent; margin-right:20px; object-fit:contain; display:block; }
        .header-text h2 { color:white; font-size:30px; margin-bottom:5px; letter-spacing:1px; text-shadow:1px 1px 2px rgba(0,0,0,0.3); }
        .header-text h3 { color:white; font-size:28px; text-align:center; text-shadow:1px 1px 2px rgba(0,0,0,0.3); }

        /* DETAILS TABLE */
        .details-section { position:absolute; top:235px; left:60px; width:650px; }
        table.details-table { width:100%; border-collapse:collapse; }
        table.details-table td { padding-bottom:12px; vertical-align:top; font-size:24px; font-weight:500; color:#000; }
        .lbl-cell { width:260px; font-weight:bold; white-space:nowrap; }
        .val-cell { word-break:break-word; }

        /* PHOTO */
        .photo-section { position:absolute; top:160px; right:60px; width:230px; height:270px; }
        .photo-frame { width:100%; height:100%; background:white; border:0px solid #000; overflow:hidden; display:flex; align-items:center; justify-content:center; }
        .photo-frame img { width:100%; height:100%; object-fit:cover; display:block; }

        /* FOOTER */
        .footer-section { position:absolute; bottom:25px; left:0; width:100%; padding:0 40px; }
        .holder-sig-box { position:absolute; bottom:80px; left:50px; width:250px; text-align:center; }
        .deputy-box { position:absolute; bottom:70px; right:30px; text-align:center; width:350px; }
        .sig-wrapper { position:relative; height:80px; width:100%; display:flex; align-items:flex-end; justify-content:center; margin-bottom:5px; overflow:visible; }
        .holder-sig-box img, .deputy-box img { display:block; height:70px; object-fit:contain; transform-origin:bottom center; }
        .line { height:3px; background:black; width:100%; margin-bottom:5px; }
        .holder-sig-box p { color:black; font-size:22px; font-weight:bold; }
        .deputy-box h2 { font-size:26px; font-weight:bold; margin-bottom:2px; color:black; }
        .deputy-box p { font-size:16px; text-transform:uppercase; color:black; }

        /* BACK SIDE */
        .back-header-bar { position:absolute; top:0; left:0; right:0; height:13%; display:flex; align-items:center; justify-content:center; z-index:5; background-color:#1e3a5f; }
        .back-header-bar h2 { color:white; font-size:26px; text-align:center; font-weight:bold; letter-spacing:1px; margin:0; padding:0 20px; }
        .back-details { top:110px; }

        /* small responsiveness for inputs in mobile preview */
        @media (max-width:480px) { .form-section { padding:12px; } table.details-table td { font-size:18px; } }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="form-section">
            <h1>Scout Card Settings</h1>
            <p class="instruction"><b>Required:</b> Use "Upload" buttons for images to fix download errors.</p>
            <div class="form-grid">
                <div class="control-panel" style="background:#e3f2fd; border-color:#90caf9;">
                    <h4>1. Upload Images</h4>
                    <div class="form-group"><label>Main Logo:</label><input type="file" id="logoUpload" accept="image/*"></div>
                    <div class="form-group"><label>Deputy Signature:</label><input type="file" id="deputyUpload" accept="image/*"></div>
                    <div class="form-group"><label>Holder Signature:</label><input type="file" id="signature" accept="image/*"></div>
                    <div class="form-group"><label>Holder Photo:</label><input type="file" id="profilePic" accept="image/*"></div>
                </div>

                <div class="control-panel">
                    <h4>2. Holder Signature Adjustments</h4>
                    <div class="slider-group"><label>Zoom:</label><input type="range" min="0.5" max="4.0" step="0.1" value="1" id="hZoom" oninput="updateSigTransform('viewSignature','h')"></div>
                    <div class="slider-group"><label>Move X:</label><input type="range" min="-150" max="150" value="0" id="hX" oninput="updateSigTransform('viewSignature','h')"></div>
                    <div class="slider-group"><label>Move Y:</label><input type="range" min="-150" max="150" value="0" id="hY" oninput="updateSigTransform('viewSignature','h')"></div>
                </div>

                <div class="control-panel">
                    <h4>3. Deputy Signature Adjustments</h4>
                    <div class="slider-group"><label>Zoom:</label><input type="range" min="0.5" max="4.0" step="0.1" value="1" id="dZoom" oninput="updateSigTransform('viewDeputySig','d')"></div>
                    <div class="slider-group"><label>Move X:</label><input type="range" min="-150" max="150" value="0" id="dX" oninput="updateSigTransform('viewDeputySig','d')"></div>
                    <div class="slider-group"><label>Move Y:</label><input type="range" min="-150" max="150" value="0" id="dY" oninput="updateSigTransform('viewDeputySig','d')"></div>
                </div>

                <div class="control-panel">
                    <h4>4. Card Details</h4>
                    <div class="form-group"><input type="text" id="name" placeholder="Name" oninput="updateCard()"></div>
                    <div class="form-group"><input type="text" id="fatherName" placeholder="Father Name" oninput="updateCard()"></div>
                    <div class="form-group">
                        <select id="designation" onchange="updateCard()">
                            <option value="Boy Scout">Boy Scout</option>
                            <option value="Shaheen Scout">Shaheen Scout</option>
                            <option value="Rover Scout">Rover Scout</option>
                        </select>
                    </div>
                    <div class="form-group"><input type="text" id="unit" placeholder="Unit Name" oninput="updateCard()"></div>
                    <div class="form-group"><input type="text" id="cnic" placeholder="CNIC/B-Form" maxlength="15" oninput="updateCard()"></div>
                    <div class="form-group"><input type="date" id="dob" onchange="updateCard()"></div>
                    <div class="form-group">
                        <select id="bloodGroup" onchange="updateCard()">
                            <option value="B +ve">B +ve</option>
                            <option value="A +ve">A +ve</option>
                            <option value="O +ve">O +ve</option>
                            <option value="AB +ve">AB +ve</option>
                            <option value="B -ve">B -ve</option>
                            <option value="A -ve">A -ve</option>
                            <option value="O -ve">O -ve</option>
                            <option value="AB -ve">AB -ve</option>
                        </select>
                    </div>
                    <div class="form-group"><input type="text" id="contact" placeholder="Contact No" oninput="updateCard()"></div>
                    <div class="form-group"><input type="text" id="address" placeholder="Address" oninput="updateCard()"></div>
                    <div class="form-group">
                        <select id="validYears" onchange="updateCard()">
                            <option value="Three">3 Years</option>
                            <option value="One">1 Year</option>
                            <option value="Two">2 Years</option>
                            <option value="Five">5 Years</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="buttons">
                <button class="btn-download" onclick="downloadSide('cardFront','Front')">⬇️ Download Front</button>
                <button class="btn-download" onclick="downloadSide('cardBack','Back')">⬇️ Download Back</button>
            </div>
        </div>

        <div class="preview-area">
            <!-- FRONT -->
            <div class="card-wrapper" id="cardFront">
                <div class="bg-pattern"></div>
                <div class="watermark"><img id="logoWatermark1" src="" alt="" style="display:none"></div>

                <div class="card-content">
                    <div class="top-header">
                        <img id="headerLogo" class="header-logo" src="" alt="" style="display:none">
                        <div class="header-text">
                            <h2>DISTRICT BOY SCOUT ASSOCIATION</h2>
                            <h3>NAUSHAHRO FEROZE</h3>
                        </div>
                    </div>

                    <div class="details-section">
                        <table class="details-table">
                            <tr>
                                <td class="lbl-cell">Name</td>
                                <td class="val-cell">: <span id="viewName">Student Name</span></td>
                            </tr>
                            <tr>
                                <td class="lbl-cell">Father Name</td>
                                <td class="val-cell">: <span id="viewFather">Father Name</span></td>
                            </tr>
                            <tr>
                                <td class="lbl-cell">Designation</td>
                                <td class="val-cell">: <span id="viewDesignation">Boy Scout</span></td>
                            </tr>
                            <tr>
                                <td class="lbl-cell">Unit</td>
                                <td class="val-cell">: <span id="viewUnit">Govt: Madd: & campus high school Naushahro feroze</span></td>
                            </tr>
                        </table>
                    </div>

                    <div class="photo-section">
                        <div class="photo-frame">
                            <img id="viewProfilePic" src="" style="display:none;" alt="Photo">
                        </div>
                    </div>

                    <div class="footer-section">
                        <div class="holder-sig-box">
                            <div class="sig-wrapper">
                                <img id="viewSignature" src="" style="display:none;" alt="Sig">
                            </div>
                            <div class="line"></div>
                            <p>Signature of holder</p>
                        </div>

                        <div class="deputy-box">
                            <div class="sig-wrapper">
                                <img id="viewDeputySig" src="" style="display:none" alt="Deputy Sig">
                            </div>
                            <div class="line"></div>
                            <h2>DEPUTY SECRETARY</h2>
                            <p>DISTRICT BOY SCOUT ASSOCIATION</p>
                            <p>NAUSHAHRO FEROZE SINDH</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- BACK -->
            <div class="card-wrapper mt-30" id="cardBack">
                <div class="bg-pattern-back"></div>
                <div class="watermark"><img id="logoWatermark2" src="" alt="" style="display:none"></div>

                <div class="card-content">
                    <div class="back-header-bar">
                        <h2>DISTRICT BOY SCOUT ASSOCIATION NAUSHAHRO FEROZE</h2>
                    </div>

                    <div class="details-section back-details">
                         <table class="details-table">
                            <tr>
                                <td class="lbl-cell">Name</td>
                                <td class="val-cell">: <span id="viewNameBack">Student Name</span></td>
                            </tr>
                            <tr>
                                <td class="lbl-cell">Father Name</td>
                                <td class="val-cell">: <span id="viewFatherBack">Father Name</span></td>
                            </tr>
                            <tr>
                                <td class="lbl-cell">CNIC</td>
                                <td class="val-cell">: <span id="viewCnic">xxxxx-xxxxxxx-x</span></td>
                            </tr>
                            <tr>
                                <td class="lbl-cell">Date of Birth</td>
                                <td class="val-cell">: <span id="viewDob">dd/mm/yyyy</span></td>
                            </tr>
                            <tr>
                                <td class="lbl-cell">Blood Group</td>
                                <td class="val-cell">: <span id="viewBlood">B +ve</span></td>
                            </tr>
                            <tr>
                                <td class="lbl-cell">Contact NO</td>
                                <td class="val-cell">: <span id="viewContact">+92 3xxxxxxxxx</span></td>
                            </tr>
                            <tr>
                                <td class="lbl-cell">Address</td>
                                <td class="val-cell">: <span id="viewAddress">College Road Naushahro feroze</span></td>
                            </tr>
                            <tr>
                                <td class="lbl-cell">Valid</td>
                                <td class="val-cell">: For <span id="viewValid">Three</span> Years</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**********************
         * Helper & Core Logic
         **********************/
        function updateCard() {
            const getVal = (id, defaultVal) => {
                const el = document.getElementById(id);
                const val = el ? el.value : '';
                return val ? val : defaultVal;
            };

            document.getElementById('viewName').innerText = getVal('name', 'Student Name');
            document.getElementById('viewNameBack').innerText = getVal('name', 'Student Name');

            document.getElementById('viewFather').innerText = getVal('fatherName', 'Father Name');
            document.getElementById('viewFatherBack').innerText = getVal('fatherName', 'Father Name');

            document.getElementById('viewDesignation').innerText = getVal('designation', 'Boy Scout');
            document.getElementById('viewUnit').innerText = getVal('unit', 'Govt: Madd: & campus high school Naushahro feroze');
            document.getElementById('viewCnic').innerText = getVal('cnic', 'xxxxx-xxxxxxx-x');

            const dobVal = document.getElementById('dob').value;
            const dobDisplay = dobVal ? new Date(dobVal).toLocaleDateString('en-GB') : 'dd/mm/yyyy';
            document.getElementById('viewDob').innerText = dobDisplay;

            document.getElementById('viewBlood').innerText = getVal('bloodGroup', 'B +ve');
            document.getElementById('viewContact').innerText = getVal('contact', '+92 3xxxxxxxxx');
            document.getElementById('viewAddress').innerText = getVal('address', 'College Road Naushahro feroze');
            document.getElementById('viewValid').innerText = getVal('validYears', 'Three');
        }

        /**********************
         * Image Uploads
         **********************/
        function handleImageUpload(inputId, imgId, displayStyle='block') {
            const input = document.getElementById(inputId);
            if(!input) return;

            input.addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(ev) {
                        const img = document.getElementById(imgId);
                        img.src = ev.target.result;
                        img.style.display = displayStyle;

                        // If this is main logo, set watermark too
                        if (inputId === 'logoUpload') {
                            const w1 = document.getElementById('logoWatermark1');
                            const w2 = document.getElementById('logoWatermark2');
                            w1.src = ev.target.result; w2.src = ev.target.result;
                            w1.style.display = displayStyle; w2.style.display = displayStyle;
                            // also show header logo
                            const header = document.getElementById('headerLogo');
                            header.src = ev.target.result; header.style.display = displayStyle;
                        }
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
        }

        handleImageUpload('profilePic', 'viewProfilePic');
        handleImageUpload('signature', 'viewSignature');
        handleImageUpload('logoUpload', 'headerLogo');
        handleImageUpload('deputyUpload', 'viewDeputySig');

        /**********************
         * Signature transform update
         **********************/
        function updateSigTransform(imgId, prefix) {
            let zoom = 1, x = 0, y = 0;
            if (prefix === 'h') {
                zoom = document.getElementById('hZoom').value;
                x = document.getElementById('hX').value;
                y = document.getElementById('hY').value;
            } else {
                zoom = document.getElementById('dZoom').value;
                x = document.getElementById('dX').value;
                y = document.getElementById('dY').value;
            }
            const img = document.getElementById(imgId);
            if (img) {
                // Use translate + scale inline; html2canvas will pick this up when cloning
                img.style.transform = `translate(${x}px, ${y}px) scale(${zoom})`;
                // keep transform origin to bottom center (defined in CSS)
            }
        }

        /**********************
         * Wait for all images in an element to load
         **********************/
        function waitForImages(el) {
            const imgs = Array.from(el.querySelectorAll('img'));
            const loadPromises = imgs.map(img => {
                if (!img.src) return Promise.resolve(); // nothing to load
                // If already loaded
                if (img.complete && img.naturalWidth !== 0) return Promise.resolve();
                return new Promise(resolve => {
                    img.onload = () => resolve();
                    img.onerror = () => resolve(); // on error just continue
                });
            });
            return Promise.all(loadPromises);
        }

        /****************************************************************
         * Download routine:
         * - clone the card element
         * - remove any preview scaling (preview-area scales the whole preview)
         * - ensure inline transforms for signatures are present (they already are)
         * - wait for images
         * - call html2canvas on the clone with a higher scale (for crispness)
         * - cleanup clone
         ****************************************************************/
        async function downloadSide(elementId, sideLabel) {
            const original = document.getElementById(elementId);
            if (!original) { alert('Element not found'); return; }

            // Simple check: if headerLogo not uploaded, warn user (but allow continue)
            const headerLogo = document.getElementById('headerLogo');
            if (!headerLogo || !headerLogo.src) {
                if (!confirm('Warning: No logo uploaded. Continue without logo?')) return;
            }

            // Clone node (deep)
            const clone = original.cloneNode(true);

            // Reset styles that may come from preview scaling or layout constraints.
            clone.style.transform = 'none';
            clone.style.position = 'absolute';
            clone.style.left = '-9999px'; // move offscreen
            clone.style.top = '-9999px';
            clone.style.margin = '0';
            // Force same size (in case CSS differs)
            clone.style.width = original.offsetWidth + 'px';
            clone.style.height = original.offsetHeight + 'px';
            clone.style.boxSizing = 'border-box';

            // Append clone to body to allow rendering
            document.body.appendChild(clone);

            // Copy current inline transforms/styles of signature images so clone inherits them.
            // (Since cloneNode(true) copies attributes and inline styles, this should be fine.)
            // But in some browsers computed transforms from sliders may not be inline; ensure they are:
            const sigs = ['viewSignature', 'viewDeputySig'];
            sigs.forEach(id => {
                const origImg = document.getElementById(id);
                const clonedImg = clone.querySelector(`#${id}`);
                if (origImg && clonedImg) {
                    // copy inline transform (if present). If not, compute from getComputedStyle.
                    const inline = origImg.getAttribute('style') || '';
                    if (inline) clonedImg.setAttribute('style', inline);
                    else {
                        // fallback to computed style
                        const cs = window.getComputedStyle(origImg);
                        if (cs.transform && cs.transform !== 'none') {
                            clonedImg.style.transform = cs.transform;
                        }
                    }
                }
            });

            // Wait for images in clone to load
            await waitForImages(clone);

            // Use html2canvas on the clone. Use scale 2 for crisp output.
            try {
                const canvas = await html2canvas(clone, {
                    scale: 2,             // higher pixel density
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: null,
                    logging: false,
                    // width/height not necessary since we cloned size, but you can set to ensure exact pixels:
                    width: clone.offsetWidth,
                    height: clone.offsetHeight
                });

                // Create download link
                const link = document.createElement('a');
                link.download = `ScoutCard_${sideLabel}_${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch (err) {
                console.error('Export error:', err);
                alert('Export failed. Browser may block canvas export of cross-origin images. Ensure you uploaded images from your device.');
            } finally {
                // Clean up clone
                clone.remove();
            }
        }

        // Initialize on load
        window.addEventListener('load', () => {
            updateCard();
            // ensure any existing transforms are applied visually
            updateSigTransform('viewSignature','h');
            updateSigTransform('viewDeputySig','d');
        });

        // Also update card when inputs change
        ['name','fatherName','designation','unit','cnic','dob','bloodGroup','contact','address','validYears'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('input', updateCard);
            if (el) el.addEventListener('change', updateCard);
        });

        // Prevent accidental drag of images (optional UX improvement)
        document.addEventListener('dragstart', function(e) {
            if (e.target && e.target.tagName === 'IMG') e.preventDefault();
        });
    </script>
</body>
</html>
